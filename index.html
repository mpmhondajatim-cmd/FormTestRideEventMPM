<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pendaftaran Test Ride MPM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    :root { --honda-red: #E4002B; }
    body { background-color: #f4f4f4; padding: 20px 10px; font-family: 'Segoe UI', sans-serif; }
    .form-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 600px; margin: auto; border-top: 8px solid var(--honda-red); }
    h4 { color: var(--honda-red); font-weight: 800; text-align: center; margin-bottom: 25px; text-transform: uppercase; }
    .btn-honda { background-color: var(--honda-red); color: white; font-weight: bold; width: 100%; padding: 12px; border: none; border-radius: 6px; }
    .btn-honda:disabled { background-color: #ccc; }
    .asterisk { color: var(--honda-red); }
    .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .select2-container--default .select2-selection--single { height: 38px; border: 1px solid #ced4da; }
    .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 36px; }
  </style>
</head>
<body>

<div id="loader" class="loader"><div class="spinner-border text-danger"></div></div>

<div class="form-container">
  <h4>Pendaftaran Test Ride</h4>
  <form id="testRideForm">
    <div class="mb-3">
      <label class="form-label">Nama Lengkap <span class="asterisk">*</span></label>
      <input type="text" name="nama" id="nama" class="form-control" placeholder="Nama sesuai KTP" required oninput="validateForm()">
    </div>

    <div class="mb-3">
      <label class="form-label">Nomor WhatsApp <span class="asterisk">*</span></label>
      <input type="tel" name="wa" id="wa" class="form-control" placeholder="Contoh: 08123456789" required oninput="cleanNumbers(this); validateForm()">
    </div>

    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label">Kota / Kabupaten <span class="asterisk">*</span></label>
        <select name="kota" id="kota" class="form-select select2" required onchange="updateKecamatanAndDealer()">
          <option value="">Memuat...</option>
        </select>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label">Kecamatan <span class="asterisk">*</span></label>
        <select name="kecamatan" id="kecamatan" class="form-select select2" disabled required onchange="validateForm()">
          <option value="">Pilih Kota dahulu...</option>
        </select>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Event <span class="asterisk">*</span></label>
      <select name="event" id="event" class="form-select select2" required onchange="validateForm()">
        <option value="">Pilih Event...</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Tipe Motor Test Ride <span class="asterisk">*</span></label>
      <select name="motorTestRide" id="motorTestRide" class="form-select select2" required onchange="validateForm()">
        <option value="">Pilih Motor...</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Dealer Terdekat (Opsional)</label>
      <select name="dealer" id="dealer" class="form-select select2" disabled>
        <option value="">Pilih kota dahulu...</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">ID FLP (Opsional)</label>
      <input type="text" name="idFlp" id="idFlp" class="form-control" placeholder="Hanya angka" oninput="cleanNumbers(this)">
    </div>

    <div class="mb-3">
      <label class="form-label">Tipe Motor Sebelumnya <span class="asterisk">*</span></label>
      <input type="text" name="motorSebelumnya" id="motorSebelumnya" class="form-control" placeholder="Contoh: Honda Vario 125" required oninput="validateForm()">
    </div>

    <div class="bg-light p-3 small mb-3 border rounded">
      <b>Kebijakan Privasi:</b> Dengan mengisi data ini, Anda setuju untuk dihubungi oleh tim kami terkait konfirmasi Test Ride dan informasi promo motor Honda.
    </div>

    <div class="form-check mb-4">
      <input class="form-check-input" type="checkbox" id="agree" required onchange="validateForm()">
      <label class="form-check-label small" for="agree"><b>Saya menyetujui kebijakan penggunaan data</b> <span class="asterisk">*</span></label>
    </div>

    <button type="submit" id="submitBtn" class="btn btn-honda" disabled>DAFTAR TEST RIDE SEKARANG</button>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // GANTI DENGAN URL WEB APP ANDA
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxMjCFkf7Dfi6E_NvNj6py6B6xqdLZHZS8XP9Aya-U1qbWynQfaGl_Yy4CXTinodKb3/exec";

  $(document).ready(function() {
    $('.select2').select2({ width: '100%' });
    
    // Load data dropdown awal
    loadOptions('getCities', 'kota');
    loadOptions('getEvents', 'event');
    loadOptions('getMotorTestRide', 'motorTestRide');
  });

  function cleanNumbers(input) {
    input.value = input.value.replace(/\D/g, '');
  }

  async function loadOptions(action, elementId, params = {}) {
    const query = new URLSearchParams({ action, ...params }).toString();
    try {
      const response = await fetch(`${SCRIPT_URL}?${query}`);
      const data = await response.json();
      const $select = $(`#${elementId}`);
      $select.empty().append('<option value="">Pilih...</option>');
      data.forEach(item => $select.append(new Option(item, item)));
      $select.trigger('change');
    } catch (e) { console.error(e); }
  }

  function updateKecamatanAndDealer() {
    const city = $('#kota').val();
    if(city) {
      $('#kecamatan, #dealer').prop('disabled', false);
      loadOptions('getDistricts', 'kecamatan', { city });
      loadOptions('getDealers', 'dealer', { city });
    }
    validateForm();
  }

  function validateForm() {
    const fields = ['nama', 'wa', 'kota', 'kecamatan', 'event', 'motorTestRide', 'motorSebelumnya'];
    const allFilled = fields.every(id => $(`#${id}`).val() && $(`#${id}`).val().trim() !== "");
    const agreed = $('#agree').is(':checked');
    $('#submitBtn').prop('disabled', !(allFilled && agreed));
  }

  $('#testRideForm').on('submit', async function(e) {
    e.preventDefault();
    $('#loader').css('display', 'flex');
    const formData = Object.fromEntries(new FormData(this));

    try {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(formData)
      });
      alert("Terima kasih! Pendaftaran Test Ride Anda telah berhasil.");
      this.reset();
      $('.select2').val('').trigger('change');
      validateForm();
    } catch (e) {
      alert("Terjadi kesalahan saat mengirim data.");
    } finally {
      $('#loader').hide();
    }
  });
</script>
</body>
</html>
